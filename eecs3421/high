-- -------------------------------------------------------------------------------------------------
-- 10. high
-- For each quest theme, show the race of avatar which has collectively earned the most scrip (sql) in loot (as total) in quests of that theme. (This assumes that all the loot is turned in for sql.) In case of ties — that is, two or more races earned exactly the same amount of sql in quests of that theme, and this is the most earned by any race — report all tying for high.
--
-- schema: theme, race, total
-- order by theme, race
WITH
    race_total AS (SELECT
                     l.theme,
                     a.race,
                     sum(t.sql) AS total
                   FROM Loot AS l, Treasure AS t, Visit AS v, Avatar AS a
                   WHERE
                     -- join Loot and Treasure to get price info
                     l.treasure = t.treasure
                     -- join Loot and Visit to get avatar name
                     AND l.login = v.login AND l.realm = v.realm AND l.day = v.day
                     -- join Visit and Avatar to get race info
                     AND v.login = a.login AND v.name = a.name
                   GROUP BY l.theme, a.race
                   ORDER BY l.theme)
SELECT *
FROM race_total AS rt
WHERE rt.total = (SELECT max(rt1.total)
                  FROM race_total AS rt1
                  GROUP BY rt1.theme
                  HAVING rt1.theme = rt.theme)
ORDER BY rt.theme, rt.race;