-- ---------------------------------------------------------------------------
-- 8. companions
-- List each occurrence in which an avatar (by login as companion1 and avatar's name as fname)
-- whose participation in quests within a given realm has always been together with a second avatar
-- (by login as companion2 and name as lname) who has participated in exactly those same quests within the realm.
-- Since each pair of such companions would be shown twice, once with avatar one and avatar two, break the tie and show each such pair (per realm) just once;
-- choose such that companion1 is before companion2 in dictionary order.
--
-- schema: companion1, fname, realm, companion2, lname
-- order by realm, companion1, fname, companion2, lname
WITH temp1 AS (SELECT DISTINCT
                 T3.companion1,
                 T3.fname,
                 T3.realm,
                 T3.companion2,
                 T3.lname
               FROM (SELECT
                       T1.login AS companion1,
                       T1.name  AS fname,
                       T1.realm,
                       T2.login AS companion2,
                       T2.name  AS lname,
                       count(*) AS "#quest"
                     FROM (SELECT DISTINCT
                             V.login,
                             V.name,
                             V.realm,
                             V.day,
                             A.theme
                           FROM Visit AS V, Actor AS A
                           WHERE V.login = A.login AND V.realm = A.realm
                                 AND V.day = A.day
                           ORDER BY V.name, V.realm) AS T1
                       LEFT JOIN (SELECT DISTINCT
                                    V.login,
                                    V.name,
                                    V.realm,
                                    V.day,
                                    A.theme
                                  FROM Visit AS V, Actor AS A
                                  WHERE V.login = A.login AND V.realm = A.realm
                                        AND V.day = A.day
                                  ORDER BY V.name, V.realm) AS T2
                         ON T1.theme = T2.theme AND T1.day = T2.day AND T1.realm = T2.realm
                     WHERE T1.name != T2.name
                     GROUP BY T1.login, T1.name, T1.realm, T2.login, T2.name
                     ORDER BY T1.login) AS T3
                 LEFT JOIN (SELECT DISTINCT
                              V1.name,
                              V1.realm,
                              count(*) AS "#quest"
                            FROM Visit AS V1, Actor AS A1
                            WHERE V1.login = A1.login AND V1.realm = A1.realm
                                  AND V1.day = A1.day
                            GROUP BY V1.name, V1.realm) AS T4
                   ON T3.fname = T4.name AND T3.realm = T4.realm
                 LEFT JOIN (SELECT DISTINCT
                              V1.name,
                              V1.realm,
                              count(*) AS "#quest"
                            FROM Visit AS V1, Actor AS A1
                            WHERE V1.login = A1.login AND V1.realm = A1.realm
                                  AND V1.day = A1.day
                            GROUP BY V1.name, V1.realm) AS T5
                   ON T3.lname = T5.name AND T3.realm = T5.realm
               WHERE T3."#quest" = T4."#quest" AND T4."#quest" = T5."#quest"
               ORDER BY T3.realm, T3.companion1, T3.fname, T3.companion2, T3.lname)
SELECT *
FROM temp1 AS T
WHERE T.companion1 < T.companion2;